(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{150:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._m(1),a("ul",[t._m(2),a("li",[a("p",[t._v("经过我们仔细筛选，总结出四套方案，待进一步考察：")]),a("blockquote",[a("p",[t._v("背景是之前的代码都是使用 react15 来写的单页应用，都写了一年多了，忽然想要 seo，WTF。。。幸好不是全部页面要做。。。")]),a("ul",[t._m(3),a("li",[t._v("react-snapshot 方案，也有类似的 react-snap，原理大致是使用 react16 的 "),a("a",{attrs:{href:"https://reactjs.org/docs/react-dom-server.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReactDOMServer"),a("OutboundLink")],1),t._v(" API 的 "),a("a",{attrs:{href:"https://reactjs.org/docs/react-dom-server.html#rendertostring",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("renderToString()")]),a("OutboundLink")],1),t._v(" 方法来实现目的。鉴于升级 webpack 和 react 二选一，我们还是倾向于成本更低的 webpack 升级方案，毕竟现在业务逻辑已经相当不少了，而16的改变又非常大。。。")]),a("li",[t._v("next.js 方案，也就是大名鼎鼎的 SSR 方案，最彻底，也最有效，but。。。改动成本太大，考虑的优先级会比较低了。")]),a("li",[t._v("因为不是所有页面都要做，所以还有种很别捏的方案是把要做 seo 的几个页面拿出来做成多页应用的模式，这种混杂模式带来的维护成本让我们一开始就不太看好这种方案。")])])])]),t._m(4),t._m(5),t._m(6),t._m(7),a("li",[a("p",[t._v("第四难，于是只好研究下升级 webpack3 的文档，好在不是很复杂。"),a("a",{attrs:{href:"https://webpack.docschina.org/migrate/3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("地址"),a("OutboundLink")],1),t._v("在这里，大部分问题顺着这份文档直接就可以解决。这里只说几个文档没说到的点，一个是 less-loader 在处理 "),a("code",[t._v("options")]),t._v(" 里的 "),a("code",[t._v("modifyVars")]),t._v(" 配置值时，之前的版本是接收字符串，新的变成了对象，还有一个是 "),a("code",[t._v("productionSourceMap")]),t._v(" 以前是直接在 config 的根目录，现在放到")]),t._m(8),t._m(9)]),a("li",[a("p",[t._v("第五难，线上打包是准备好了，本地的 devServer 是不是也得升级下？！答案是毋庸置疑的，必须升了，这里也遇到一个大坑，起服务的时候在 webpack 的加密文件也就是 crypto.js 里爆出了 "),a("code",[t._v("updateHash")]),t._v(" 方法接收到参数必须是一个字符串或者 buffer（TypeError: Data must be a string or a buffer），坑就坑在完全不知道是哪个模块出的问题，从狗哥里搜到的答案都说是某些文件未找到，至于是哪个文件全靠自己猜了。。。WTF，继续翻官方的 github issue，发现有一个很火的 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/issues/4072",target:"_blank",rel:"noopener noreferrer"}},[t._v("issue"),a("OutboundLink")],1),t._v("，参与讨论的就有90多个人，其中真正高质量的是一个叫做 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/issues/4072#issuecomment-277246246",target:"_blank",rel:"noopener noreferrer"}},[t._v("Toub"),a("OutboundLink")],1),t._v("的大佬的方案，直接在模块打包的 "),a("code",[t._v("HarmonyExportImportedSpecifierDependency.js")]),t._v(" 里的方法稍微改写就可以跟踪到：")]),t._m(10),t._m(11),t._m(12),t._m(13),t._m(14),a("p",[t._v("这里已经提示了当前模块的源头，请求等信息，分析之后即可得出结论。")]),a("p",[t._v("最终查到了出问题的模块，改完解决，庆祝下~")])]),t._m(15)])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"记录-react15-webpack1-的-seo-优化之路-1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#记录-react15-webpack1-的-seo-优化之路-1","aria-hidden":"true"}},[this._v("#")]),this._v(" 记录 react15 + webpack1 的 seo 优化之路(1)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案","aria-hidden":"true"}},[this._v("#")]),this._v(" 方案")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("(据 pm 讲需求方很早就提过，但是之前没能力或者排期做)，总而言之在项目已经进展到第三期的时候忽然要加 seo 的优化，WTF。。。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[this._v("Webpack 插件方案，也就是很有名的 "),s("code",[this._v("prerender-spa-plugin")]),this._v(" 插件，最新的3.x版本原理是使用 Chrome 的 puppeteer 在内部浏览器预先生成就让爬虫爬取静态 html 资源来达到目的。理论上这种方案成本最小，最容易实现，就是不知道我们那古老的 webpack 版本是否支持，后面果然采坑。。。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("好了，既然倾向于第一种方案，那就直接开撸吧。九九八十一难开始。。。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("第一难是 puppeteer 每次都要下载一个78M左右的 Chrome 内核，期间经历过将下载主机设置淘宝镜像(在 "),a("code",[t._v(".npmrc文")]),t._v("件中设置 "),a("code",[t._v("type puppeteer_download_host=https://npm.taobao.org/mirrors")]),t._v(")，结果有时可以，有时又不行。。。于是果断听从官方建议将默认下载关掉(同样是在 "),a("code",[t._v(".npmrc")]),t._v(" 文件里加 "),a("code",[t._v("PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true")]),t._v(")，然后自己手动下载好（奇怪的是通过下载软件下载速度飞快。。。）之后移到 "),a("code",[t._v("PROJECT_NAME/node_modules/prerender-spa-plugin/.local-chromium")]),t._v("文件夹下。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("第二难，puppeteer 装好之后，愉快的执行 webpack，然并卵，预期生成的文件夹并没有生成，命令行只是报了一个 "),a("code",[t._v("[error] unable to prerender all routes!")]),t._v(" google 走起，发现同病相怜的人还真是不少，但是原因五花八门。。。直到翻到一个 issue 里面 "),a("code",[t._v("prerender")]),t._v(" 插件的作者写的这个报错都是由于 routes 里多传了 "),a("code",[t._v("undefined")]),t._v("。这提示我们可能是路由写的有问题，于是在尝试改了路由之后。。。。。。仍然无解，报错还是一样的，导致我们差点怀疑作者说的是不是不够全面。。。于是只好在源码里通过这个报错信息来跟踪错误的源头，逐步加日志输出，发现代码在打开puppeteer 的 Chrome 内核之后爬取的页面仍然是首页，也就是说并不是 react 执行之后生成的资源，继续 debug 最终发现 webpack 的 "),a("code",[t._v("publicPath")]),t._v(" 路径导致没有生成正确的资源（线上的 path 里面包括 Nginx 配置的路径，本地没有）。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("第三难，这时候爬取的页面是没有问题了，但是仍然没有生成文件夹，继续 debug 发现在使用 "),a("code",[t._v("compiler")]),t._v(" 编译器的 "),a("code",[t._v("outputFileSystem")]),t._v(" 对象时，竟然是 "),a("code",[t._v("null")]),t._v("，WTF。。。狗哥走起，发现 node.js 本身有自己的 "),a("code",[t._v("outputFileSystem")]),t._v(" 但是 webpack 对它进行了改写，在 webpack 的源码里也证实了这一点。那就应该是 webpack 里的这个对象出了问题，开始我们想既然它可以创建外层的文件夹，为什么不能创建内部的文件夹呢。。。这一点没有继续深入跟踪。。。在 "),a("code",[t._v("prerender-spa-plugin")]),t._v(" 的 issue 里面继续搜 "),a("code",[t._v("outputFileSystem")]),t._v(" 关键词，发现还真有那么两三个人也遇到这个问题，无一例外的都是因为 webpack 版本不对，然后看到作者说他自己是在 webpack3 的基础上开发测试的，因为只能支持到 webpack3。一开始害怕的终于成真。。。还真是需要升级 webpack 版本呐。。。这时我还想着看看另一个方案也就是 react-snapshot 的方案，搜索一番之后，发现还得借助 react16 的 API，我滴乖乖，就现在那至少没有上千至少也有几百的文件，真要升级，恐怕得脱几层皮不可。。。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("webpack"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LoaderOptionsPlugin")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  options"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    productionSourceMap"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("顺便提一句，类似的还有开发模式里的 "),s("code",[this._v("debug")]),this._v(" 也是放到这里配置了，这个插件据说是专门为了从1到2或者3迁移用的，用以兼容1的配置。好了现在创建文件夹也可以成功了。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("updateHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("super")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("updateHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hashValue "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("getHashValue")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("importDependency"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("importDependency"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("null")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// console.log('Module resource: ', this.importDependency.module.resource);")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'\\nFile not found: '")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("importDependency"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("update")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hashValue"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("改完之后，发现毛都没有输出，哪来的 "),s("code",[this._v("File not found:")]),this._v(" 呢。。。再次卡住，于是转变思路，看看正常模块打包到哪出现了问题，而不是继续找未找到的模块，发现每次都是打包完一个固定的模块出现这个报错，那我就看看文件里面跟这个模块相邻的模块不就可以猜到嘛。。。机智如我。。。但是这还不足以确认，继续 debug，发现有个 "),s("code",[this._v("DelegatedModule.js")]),this._v(" 的 updateHash 也可以查看到打包的模块的各种属性，而且找到了错误的直接来源：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("updateHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("update")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("update")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("stringify")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("super")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("updateHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("正因为这里的 this.request 为 "),s("code",[this._v("undefined")]),this._v(" 导致了报错，于是就看了看 request 是 "),s("code",[this._v("undefined")]),this._v(" 的时候其它属性是什么。在它的构造函数里发现了重要线索：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("constructor")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sourceRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" originalRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("super")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sourceRequest "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" sourceRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("meta "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("meta"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("originalRequest "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" originalRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userRequest "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" userRequest"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("built "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("false")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delegated "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("true")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("this")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delegateData "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("至此，本地服务也可以正常运行，线上打包也可以正常输出。优化第一步完成。后续问题放在下篇。")])])}],!1,null,null,null);s.default=e.exports}}]);