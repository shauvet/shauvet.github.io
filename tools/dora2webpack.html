<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>dorajs 迁移 webpack 4 简单记录 | shauvet</title>
    <meta name="description" content="我的 BLOG">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    
    <link rel="preload" href="/assets/css/17.styles.d7a3b500.css" as="style"><link rel="preload" href="/assets/js/app.5ebfa77d.js" as="script"><link rel="preload" href="/assets/js/1.45bd451f.js" as="script"><link rel="prefetch" href="/assets/js/0.272147ad.js"><link rel="prefetch" href="/assets/js/2.8e4c1614.js"><link rel="prefetch" href="/assets/js/3.33aff05a.js"><link rel="prefetch" href="/assets/js/4.f764b81a.js"><link rel="prefetch" href="/assets/js/5.1c7fe777.js"><link rel="prefetch" href="/assets/js/6.c674926d.js"><link rel="prefetch" href="/assets/js/7.ead99731.js"><link rel="prefetch" href="/assets/js/8.a11b5416.js"><link rel="prefetch" href="/assets/js/9.242dfc43.js"><link rel="prefetch" href="/assets/js/10.97faa3c3.js"><link rel="prefetch" href="/assets/js/11.c66eab63.js"><link rel="prefetch" href="/assets/js/12.6303c37e.js"><link rel="prefetch" href="/assets/js/13.3e0a6290.js"><link rel="prefetch" href="/assets/js/14.7ec6bf49.js"><link rel="prefetch" href="/assets/js/15.f06d7b64.js"><link rel="prefetch" href="/assets/js/16.be0aa23d.js">
    <link rel="stylesheet" href="/assets/css/17.styles.d7a3b500.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      shauvet
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://cn.bing.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  BING
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://cn.bing.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  BING
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><a href="/tools/" class="sidebar-link">记录 react15 + webpack1 的 seo 优化之路(1)</a></li><li><a href="/tools/dev-server.html" class="sidebar-link">一份经典（传统）的前端本地开发环境搭建流程</a></li><li><a href="/tools/dora2webpack.html" class="active sidebar-link">dorajs 迁移 webpack 4 简单记录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/dora2webpack.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/tools/dora2webpack.html#遇到的问题" class="sidebar-link">遇到的问题</a></li><li class="sidebar-sub-header"><a href="/tools/dora2webpack.html#最终效果" class="sidebar-link">最终效果</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="dorajs-迁移-webpack-4-简单记录"><a href="#dorajs-迁移-webpack-4-简单记录" aria-hidden="true" class="header-anchor">#</a> dorajs 迁移 webpack 4 简单记录</h1><p>只能简单记录，因为还要修 bug，逃~</p><h2 id="背景"><a href="#背景" aria-hidden="true" class="header-anchor">#</a> 背景</h2><p>原有的 dorajs 起服务经常莫名崩溃，而且经常需要少则十几分钟多则半小时的启动时间（根据不同机型不定），虽说可以通过插件形式定制，但是官方项目已经三四年不更新，让我们对稳定性存疑，而且文档也不完整，处于不维护状态。整个项目别说领先时代，已经严重脱离时代了。这构成了我们决定升级或者说迁移工程的直接原因。</p><p>不提已经明日黄花的 grunt，bower 等，现在流行的打包工具有 webpack，parcel，以及未来可能流行的 snowpack，针对 vue 的 vite 等，如果可以直接一步到位当然谁都喜欢了，但是 snowpack 对我们这种已经存在三四年的工程确实兼容性是问题。 Parcel  最大的优点本来是免配置，但是这一点现在被 webpack 学去了不少。所以综合考虑下来 最稳妥的选择仍然是 webpack。webpack 5 虽然有很多新特性，但是仍然处于 beta 版。而且考虑到我们现有庞大的项目，稳定性是最重要的，最终决定选择 webpack 4。</p><h2 id="遇到的问题"><a href="#遇到的问题" aria-hidden="true" class="header-anchor">#</a> 遇到的问题</h2><p>安装 webpack，以及一堆插件不提，只说遇到的常见问题。</p><h3 id="babel-6和7的兼容性问题"><a href="#babel-6和7的兼容性问题" aria-hidden="true" class="header-anchor">#</a> babel 6和7的兼容性问题</h3><p>babel 7是 break change，而且跟6严重不兼容，包括但不限于 @babel 命名域，pollfill 包，corejs 包，regenerater 包等等。具体可以参考 <a href="https://mp.weixin.qq.com/s/4zbdf1lQ9ElO0mJ-jEDK_A" target="_blank" rel="noopener noreferrer">babel7升级指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>各种 找不到 default 属性的问题，原因是因为 babel 改变了模块的编译方法。需要引入 babel-plugin-add-module-exports 包解决。</p><h3 id="css-处理的问题"><a href="#css-处理的问题" aria-hidden="true" class="header-anchor">#</a> css 处理的问题</h3><p>原来的 extractTextWebpackPlugin 需要替换为 miniCssExtractPlugin.</p><p>启用 css-loader 的 CSSModule 功能.</p><h3 id="其它"><a href="#其它" aria-hidden="true" class="header-anchor">#</a> 其它</h3><p>externals 与 js 模块(umd，commonjs，commonjs2等)的关系。参考 <a href="https://webpack.js.org/configuration/externals/#root" target="_blank" rel="noopener noreferrer">externals<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>htmlWebpackPlugin 的模板变量读取。参考 <a href="https://github.com/jantimon/html-webpack-plugin" target="_blank" rel="noopener noreferrer">htmlWebpackPlugin.options<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>热更新的问题（现在仍然不完善，只能算是半个完成品）。</p><p>production 模式自带的 terserWebpackPlugin 压缩代码内存溢出的问题。最终解决是 mode 为 none，然后用自设的新版 terser 插件解决，怀疑是默认自带的插件 bug，网上的各种说法都有。</p><p>HardSourceWebpackPlugin 的代码缓存失效问题。自动删或者手动删。</p><p>预压缩插件 compressionWebpackPlugin 里面 gzip 算法与 zopfli 算法的选择。（参考 <a href="https://slashgear.github.io/why-you-should-use-compression-webpack-plugin/" target="_blank" rel="noopener noreferrer">为什么应该用预压缩插件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p><h2 id="最终效果"><a href="#最终效果" aria-hidden="true" class="header-anchor">#</a> 最终效果</h2><p>服务启动时间第一次比之前减少不多，大约4分之一，但是第二次第三次等等，后续启动时间比之前缩短90%的时间。</p><p>上线打包因为加入了预压缩等技术，时间有所延长，不过换来的是文件体积大幅缩小，不需要服务器 nginx 压缩，加载速度提升 30%左右。</p><p>时间原因，暂未引入 tree shaking 技术，不过已经为后续引入提供了基础条件。</p><p>最主要的是不再像之前的 dora 配置是个黑盒，我们现在是保持半开放，可以更加灵活的配置。</p><p>也算是部分跟上了时代的步伐。。。待续。。。</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/tools/dev-server.html" class="prev">
          一份经典（传统）的前端本地开发环境搭建流程
        </a></span><!----></p></div></div></div></div>
    <script src="/assets/js/1.45bd451f.js" defer></script><script src="/assets/js/app.5ebfa77d.js" defer></script>
  </body>
</html>
