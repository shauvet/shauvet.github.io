<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>记录 react15 + webpack1 的 seo 优化之路(1) | shauvet</title>
    <meta name="description" content="我的 BLOG">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    
    <link rel="preload" href="/assets/css/17.styles.d7a3b500.css" as="style"><link rel="preload" href="/assets/js/app.5ebfa77d.js" as="script"><link rel="preload" href="/assets/js/0.272147ad.js" as="script"><link rel="prefetch" href="/assets/js/1.45bd451f.js"><link rel="prefetch" href="/assets/js/2.8e4c1614.js"><link rel="prefetch" href="/assets/js/3.33aff05a.js"><link rel="prefetch" href="/assets/js/4.f764b81a.js"><link rel="prefetch" href="/assets/js/5.1c7fe777.js"><link rel="prefetch" href="/assets/js/6.c674926d.js"><link rel="prefetch" href="/assets/js/7.ead99731.js"><link rel="prefetch" href="/assets/js/8.a11b5416.js"><link rel="prefetch" href="/assets/js/9.242dfc43.js"><link rel="prefetch" href="/assets/js/10.97faa3c3.js"><link rel="prefetch" href="/assets/js/11.c66eab63.js"><link rel="prefetch" href="/assets/js/12.6303c37e.js"><link rel="prefetch" href="/assets/js/13.3e0a6290.js"><link rel="prefetch" href="/assets/js/14.7ec6bf49.js"><link rel="prefetch" href="/assets/js/15.f06d7b64.js"><link rel="prefetch" href="/assets/js/16.be0aa23d.js">
    <link rel="stylesheet" href="/assets/css/17.styles.d7a3b500.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      shauvet
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://cn.bing.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  BING
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://cn.bing.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  BING
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><a href="/tools/" class="active sidebar-link">记录 react15 + webpack1 的 seo 优化之路(1)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tools/#方案" class="sidebar-link">方案</a></li></ul></li><li><a href="/tools/dev-server.html" class="sidebar-link">一份经典（传统）的前端本地开发环境搭建流程</a></li><li><a href="/tools/dora2webpack.html" class="sidebar-link">dorajs 迁移 webpack 4 简单记录</a></li></ul></div><div class="page"><div class="content"><h1 id="记录-react15-webpack1-的-seo-优化之路-1"><a href="#记录-react15-webpack1-的-seo-优化之路-1" aria-hidden="true" class="header-anchor">#</a> 记录 react15 + webpack1 的 seo 优化之路(1)</h1><h2 id="方案"><a href="#方案" aria-hidden="true" class="header-anchor">#</a> 方案</h2><ul><li><p>(据 pm 讲需求方很早就提过，但是之前没能力或者排期做)，总而言之在项目已经进展到第三期的时候忽然要加 seo 的优化，WTF。。。</p></li><li><p>经过我们仔细筛选，总结出四套方案，待进一步考察：</p><blockquote><p>背景是之前的代码都是使用 react15 来写的单页应用，都写了一年多了，忽然想要 seo，WTF。。。幸好不是全部页面要做。。。</p><ul><li>Webpack 插件方案，也就是很有名的 <code>prerender-spa-plugin</code> 插件，最新的3.x版本原理是使用 Chrome 的 puppeteer 在内部浏览器预先生成就让爬虫爬取静态 html 资源来达到目的。理论上这种方案成本最小，最容易实现，就是不知道我们那古老的 webpack 版本是否支持，后面果然采坑。。。</li><li>react-snapshot 方案，也有类似的 react-snap，原理大致是使用 react16 的 <a href="https://reactjs.org/docs/react-dom-server.html" target="_blank" rel="noopener noreferrer">ReactDOMServer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> API 的 <a href="https://reactjs.org/docs/react-dom-server.html#rendertostring" target="_blank" rel="noopener noreferrer"><code>renderToString()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法来实现目的。鉴于升级 webpack 和 react 二选一，我们还是倾向于成本更低的 webpack 升级方案，毕竟现在业务逻辑已经相当不少了，而16的改变又非常大。。。</li><li>next.js 方案，也就是大名鼎鼎的 SSR 方案，最彻底，也最有效，but。。。改动成本太大，考虑的优先级会比较低了。</li><li>因为不是所有页面都要做，所以还有种很别捏的方案是把要做 seo 的几个页面拿出来做成多页应用的模式，这种混杂模式带来的维护成本让我们一开始就不太看好这种方案。</li></ul></blockquote></li><li><p>好了，既然倾向于第一种方案，那就直接开撸吧。九九八十一难开始。。。</p></li><li><p>第一难是 puppeteer 每次都要下载一个78M左右的 Chrome 内核，期间经历过将下载主机设置淘宝镜像(在 <code>.npmrc文</code>件中设置 <code>type puppeteer_download_host=https://npm.taobao.org/mirrors</code>)，结果有时可以，有时又不行。。。于是果断听从官方建议将默认下载关掉(同样是在 <code>.npmrc</code> 文件里加 <code>PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true</code>)，然后自己手动下载好（奇怪的是通过下载软件下载速度飞快。。。）之后移到 <code>PROJECT_NAME/node_modules/prerender-spa-plugin/.local-chromium</code>文件夹下。</p></li><li><p>第二难，puppeteer 装好之后，愉快的执行 webpack，然并卵，预期生成的文件夹并没有生成，命令行只是报了一个 <code>[error] unable to prerender all routes!</code> google 走起，发现同病相怜的人还真是不少，但是原因五花八门。。。直到翻到一个 issue 里面 <code>prerender</code> 插件的作者写的这个报错都是由于 routes 里多传了 <code>undefined</code>。这提示我们可能是路由写的有问题，于是在尝试改了路由之后。。。。。。仍然无解，报错还是一样的，导致我们差点怀疑作者说的是不是不够全面。。。于是只好在源码里通过这个报错信息来跟踪错误的源头，逐步加日志输出，发现代码在打开puppeteer 的 Chrome 内核之后爬取的页面仍然是首页，也就是说并不是 react 执行之后生成的资源，继续 debug 最终发现 webpack 的 <code>publicPath</code> 路径导致没有生成正确的资源（线上的 path 里面包括 Nginx 配置的路径，本地没有）。</p></li><li><p>第三难，这时候爬取的页面是没有问题了，但是仍然没有生成文件夹，继续 debug 发现在使用 <code>compiler</code> 编译器的 <code>outputFileSystem</code> 对象时，竟然是 <code>null</code>，WTF。。。狗哥走起，发现 node.js 本身有自己的 <code>outputFileSystem</code> 但是 webpack 对它进行了改写，在 webpack 的源码里也证实了这一点。那就应该是 webpack 里的这个对象出了问题，开始我们想既然它可以创建外层的文件夹，为什么不能创建内部的文件夹呢。。。这一点没有继续深入跟踪。。。在 <code>prerender-spa-plugin</code> 的 issue 里面继续搜 <code>outputFileSystem</code> 关键词，发现还真有那么两三个人也遇到这个问题，无一例外的都是因为 webpack 版本不对，然后看到作者说他自己是在 webpack3 的基础上开发测试的，因为只能支持到 webpack3。一开始害怕的终于成真。。。还真是需要升级 webpack 版本呐。。。这时我还想着看看另一个方案也就是 react-snapshot 的方案，搜索一番之后，发现还得借助 react16 的 API，我滴乖乖，就现在那至少没有上千至少也有几百的文件，真要升级，恐怕得脱几层皮不可。。。</p></li><li><p>第四难，于是只好研究下升级 webpack3 的文档，好在不是很复杂。<a href="https://webpack.docschina.org/migrate/3/" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>在这里，大部分问题顺着这份文档直接就可以解决。这里只说几个文档没说到的点，一个是 less-loader 在处理 <code>options</code> 里的 <code>modifyVars</code> 配置值时，之前的版本是接收字符串，新的变成了对象，还有一个是 <code>productionSourceMap</code> 以前是直接在 config 的根目录，现在放到</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>LoaderOptionsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    productionSourceMap<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><p>顺便提一句，类似的还有开发模式里的 <code>debug</code> 也是放到这里配置了，这个插件据说是专门为了从1到2或者3迁移用的，用以兼容1的配置。好了现在创建文件夹也可以成功了。</p></li><li><p>第五难，线上打包是准备好了，本地的 devServer 是不是也得升级下？！答案是毋庸置疑的，必须升了，这里也遇到一个大坑，起服务的时候在 webpack 的加密文件也就是 crypto.js 里爆出了 <code>updateHash</code> 方法接收到参数必须是一个字符串或者 buffer（TypeError: Data must be a string or a buffer），坑就坑在完全不知道是哪个模块出的问题，从狗哥里搜到的答案都说是某些文件未找到，至于是哪个文件全靠自己猜了。。。WTF，继续翻官方的 github issue，发现有一个很火的 <a href="https://github.com/webpack/webpack/issues/4072" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，参与讨论的就有90多个人，其中真正高质量的是一个叫做 <a href="https://github.com/webpack/webpack/issues/4072#issuecomment-277246246" target="_blank" rel="noopener noreferrer">Toub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的大佬的方案，直接在模块打包的 <code>HarmonyExportImportedSpecifierDependency.js</code> 里的方法稍微改写就可以跟踪到：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">updateHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hashValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHashValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>importDependency<span class="token punctuation">.</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>importDependency<span class="token punctuation">.</span>module <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// console.log('Module resource: ', this.importDependency.module.resource);</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\nFile not found: '</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>importDependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>hashValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>改完之后，发现毛都没有输出，哪来的 <code>File not found:</code> 呢。。。再次卡住，于是转变思路，看看正常模块打包到哪出现了问题，而不是继续找未找到的模块，发现每次都是打包完一个固定的模块出现这个报错，那我就看看文件里面跟这个模块相邻的模块不就可以猜到嘛。。。机智如我。。。但是这还不足以确认，继续 debug，发现有个 <code>DelegatedModule.js</code> 的 updateHash 也可以查看到打包的模块的各种属性，而且找到了错误的直接来源：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">updateHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正因为这里的 this.request 为 <code>undefined</code> 导致了报错，于是就看了看 request 是 <code>undefined</code> 的时候其它属性是什么。在它的构造函数里发现了重要线索：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">constructor</span><span class="token punctuation">(</span>sourceRequest<span class="token punctuation">,</span> data<span class="token punctuation">,</span> type<span class="token punctuation">,</span> userRequest<span class="token punctuation">,</span> originalRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sourceRequest <span class="token operator">=</span> sourceRequest<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> data<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>meta <span class="token operator">=</span> data<span class="token punctuation">.</span>meta<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>originalRequest <span class="token operator">=</span> originalRequest<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>userRequest <span class="token operator">=</span> userRequest<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>built <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>delegated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>delegateData <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里已经提示了当前模块的源头，请求等信息，分析之后即可得出结论。</p><p>最终查到了出问题的模块，改完解决，庆祝下~</p></li><li><p>至此，本地服务也可以正常运行，线上打包也可以正常输出。优化第一步完成。后续问题放在下篇。</p></li></ul></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><!----><span class="next"><a href="/tools/dev-server.html">
          一份经典（传统）的前端本地开发环境搭建流程
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/0.272147ad.js" defer></script><script src="/assets/js/app.5ebfa77d.js" defer></script>
  </body>
</html>
